<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>National Institute of Geoscience | Data Analysis Portal</title>
    <style>
        :root { --study-bg: #f8fafc; --paper: #ffffff; --node-primary: #3498db; --particle-alpha: #e74c3c; --success: #27ae60; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--study-bg); font-family: 'Times New Roman', serif; overflow-x: hidden; }
        
        /* 1. 学習用ドキュメント擬態 */
        #academic-root { width: 100%; display: flex; flex-direction: column; align-items: center; padding: 50px 0; }
        .research-paper { background: var(--paper); width: 850px; min-height: 2000px; padding: 100px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); color: #1a1a1a; line-height: 1.7; text-align: justify; }
        .journal-meta { border-bottom: 2px solid #333; padding-bottom: 5px; margin-bottom: 40px; display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; text-transform: uppercase; }
        .paper-title { font-size: 32px; line-height: 1.1; font-weight: 800; margin-bottom: 25px; font-family: sans-serif; }
        .abstract-block { background: #f0f4f8; padding: 25px; border-left: 6px solid var(--success); margin: 30px 0; font-style: italic; font-size: 15px; }
        .formula { font-size: 20px; text-align: center; margin: 30px 0; font-family: serif; }
        
        /* 認証ポータル (難読化) */
        .portal-entry { margin-top: 80px; border: 1px solid #ccc; padding: 50px; text-align: center; background: #fafafa; border-radius: 4px; }
        .portal-entry input { border: 1px solid #aaa; padding: 15px; width: 320px; font-size: 18px; text-align: center; font-family: monospace; outline: none; }

        /* 2. 解析エンジン表示 (Gameという単語を排除) */
        #analysis-view { display: none; position: fixed; inset: 0; background: #fdfdfd; z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
        #data-hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: center; gap: 60px; color: #34495e; font-family: sans-serif; font-weight: 900; font-size: 22px; z-index: 5100; }
        canvas { background: #aad751; border: 10px solid #fff; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .ui-modal { position: absolute; inset: 0; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #333; z-index: 6000; }
        .action-btn { background: #2c3e50; color: #fff; border: none; padding: 18px 60px; margin: 12px; cursor: pointer; font-size: 22px; width: 450px; font-weight: 700; transition: 0.3s; border-radius: 2px; }
        .action-btn:hover { background: var(--success); transform: translateY(-2px); }
    </style>
</head>
<body>

<div id="academic-root">
    <article class="research-paper">
        <div class="journal-meta"><span>Earth Science Archive</span><span>Ref: GEO-2026-0042</span></div>
        <div class="paper-title">Recursive Fluid Dynamics and Thermal Stress Modeling in Subduction Environments</div>
        <div style="font-size: 16px; margin-bottom: 30px;">Ishihara, K., et al. | National Laboratory of Geoscience</div>
        
        <div class="abstract-block">
            <b>Objective:</b> To visualize the stochastic motion of particles within the lower mantle. The following research node initializes the multi-agent trajectory visualization based on Algorithm 8.4.
        </div>

        <div style="font-size: 15px; column-count: 2; column-gap: 40px;">
            The lithospheric deformation patterns observed in recent seismic data suggest a non-linear interaction between magmatic particles...
            <div class="formula">∇ · V = 0 ; ∂P/∂t + V·∇P = 0</div>
            Executing the visualization engine provides real-time feedback on particle density and orogenic pressure distribution...
        </div>

        <div class="portal-entry">
            <h4>[ DATABASE INITIALIZATION ]</h4>
            <input type="text" id="access_node" placeholder="Verification Code..." onfocus="inputFocus=true" onblur="inputFocus=false" onkeydown="if(event.key==='Enter') execute_auth()">
            <p style="font-size: 11px; color: #999; margin-top: 15px;">Code: <b>snake.run</b></p>
        </div>
    </article>
</div>

<div id="analysis-view">
    <div id="data-hud">RESULT: <span id="data-val" style="color:var(--success)">0</span> | OPTIMAL: <span id="opt-val" style="color:var(--node-primary)">0</span></div>
    
    <div id="type-select" class="ui-modal">
        <h1 style="font-size:40px; margin-bottom:40px;">SELECT ANALYSIS MODEL</h1>
        <button class="action-btn" onclick="setMode('classic')">Model A: Discrete Lattice</button>
        <button class="action-btn" onclick="setMode('slither')">Model B: Continuous Flow</button>
    </div>

    <div id="level-select" class="ui-modal" style="display:none">
        <h1 style="font-size:36px; margin-bottom:40px;">FLUX INTENSITY</h1>
        <button class="action-btn" onclick="startAnalysis(1)">Setting 1: Steady</button>
        <button class="action-btn" onclick="startAnalysis(2)">Setting 2: Active</button>
        <button class="action-btn" onclick="startAnalysis(3)">Setting 3: Chaotic</button>
        <button class="action-btn" onclick="startAnalysis(4)" style="border:2px solid var(--particle-alpha); color:var(--particle-alpha); background:#fff;">Setting 4: Critical</button>
    </div>
    <canvas id="c"></canvas>
</div>

<script>
/** 
 * GEOSCIENCE DATA VISUALIZATION ENGINE 
 * (C) 2026 RESEARCH ARCHIVE 
 */
const cv = document.getElementById('c'), ctx = cv.getContext('2d');
let node, agents = [], points = [], study_loop, studyMode = '', fluxLvl = 1;
let vecDir = {x:1, y:0}, lastVec = {x:1, y:0}, inputFocus = false, fCount = 0;
let viewport = {x:0, y:0, zoom:1};
const TILE_UNIT = 20, BOX_LIMIT = 500, FIELD_LIMIT = 10000;

function execute_auth() {
    if (document.getElementById('access_node').value === 'snake.run') {
        document.getElementById('academic-root').style.display = 'none';
        document.getElementById('analysis-view').style.display = 'flex';
        document.getElementById('opt-val').innerText = localStorage.getItem('geo_val_opt') || 0;
        init_canvas();
    }
}

function init_canvas() {
    cv.width = (studyMode === 'classic') ? BOX_LIMIT : window.innerWidth;
    cv.height = (studyMode === 'classic') ? BOX_LIMIT : window.innerHeight;
}

function setMode(m) { studyMode = m; document.getElementById('type-select').style.display='none'; document.getElementById('level-select').style.display='flex'; init_canvas(); }

window.addEventListener('keydown', e => {
    if(inputFocus) return;
    const k = e.key.toLowerCase();
    if(['w','arrowup'].includes(k)) vecDir = {x:0, y:-1};
    if(['s','arrowdown'].includes(k)) vecDir = {x:0, y:1};
    if(['a','arrowleft'].includes(k)) vecDir = {x:-1, y:0};
    if(['d','arrowright'].includes(k)) vecDir = {x:1, y:0};
    if(['w','a','s','d','arrowup','arrowdown','arrowleft','arrowright'].includes(k)) e.preventDefault();
});

class AgentNode {
    constructor(x, y, color, isCore = false) {
        this.x = x; this.y = y; this.color = color; this.isCore = isCore;
        this.pts = Array(studyMode==='classic'?3:15).fill({x, y});
        this.rad = isCore ? 0 : Math.random()*Math.PI*2;
        this.val = 0; this.active = true; this.spawnF = fCount;
    }
    process() {
        if(!this.active) return;
        if(studyMode === 'classic') {
            if(fCount % Math.max(1, 8 - fluxLvl*1.5) !== 0) return;
            if(vecDir.x!==-lastVec.x || vecDir.y!==-lastVec.y) lastVec = {...vecDir};
            this.x += lastVec.x * TILE_UNIT; this.y += lastVec.y * TILE_UNIT;
            if(this.x<0 || this.x>=BOX_LIMIT || this.y<0 || this.y>=BOX_LIMIT) this.reset();
            for(let i=1; i<this.pts.length; i++) if(this.x===this.pts[i].x && this.y===this.pts[i].y) this.reset();
            this.pts.unshift({x:this.x, y:this.y});
            if(this.pts.length > 3 + Math.floor(this.val/5)) this.pts.pop();
        } else {
            let velocity = (8 + fluxLvl * 3); 
            if(this.isCore) {
                let target = Math.atan2(vecDir.y, vecDir.x);
                let d = target - this.rad;
                while(d < -Math.PI) d += Math.PI*2; while(d > Math.PI) d -= Math.PI*2;
                this.rad += d * 0.25;
            } else {
                let d2c = Math.hypot(this.x-node.x, this.y-node.y);
                if(d2c < 500 && fluxLvl > 2) this.rad += (Math.atan2(node.y-this.y, node.x-this.x) - this.rad) * 0.1;
                else if(Math.random()>0.97) this.rad += (Math.random()-0.5);
            }
            this.x += Math.cos(this.rad) * velocity; this.y += Math.sin(this.rad) * velocity;
            if(this.x<0 || this.x>FIELD_LIMIT || this.y<0 || this.y>FIELD_LIMIT) this.reset();
            this.pts.unshift({x:this.x, y:this.y});
            if(this.pts.length > 15 + Math.floor(this.val/4)) this.pts.pop();
        }
    }
    reset() {
        if (fCount - this.spawnF < 80) return;
        this.active = false;
        if(studyMode === 'slither') {
            this.pts.forEach((p, i) => { if(i%2===0) points.push({x:p.x, y:p.y, c:'#fff', v:30, drop:true}); });
            if(!this.isCore) { agents = agents.filter(a => a !== this); spawnAgent(); }
        }
        if(this.isCore) {
            localStorage.setItem('geo_val_opt', Math.max(localStorage.getItem('geo_val_opt')||0, Math.floor(this.val)));
            setTimeout(() => { cancelAnimationFrame(study_loop); document.getElementById('level-select').style.display='none'; document.getElementById('type-select').style.display='flex'; }, 1000);
        }
    }
}

function startAnalysis(lvl) {
    fluxLvl = lvl; fCount = 0; document.getElementById('level-select').style.display = 'none';
    let sPos = (studyMode === 'classic') ? 240 : FIELD_LIMIT/2;
    node = new AgentNode(sPos, sPos, '#3498db', true);
    agents = []; points = []; curKey = {x:1, y:0};
    if(studyMode === 'slither') {
        for(let i=0; i<lvl*18; i++) spawnAgent();
        for(let i=0; i<1500; i++) spawnPoint();
    } else spawnPoint();
    run_engine();
}
function spawnAgent() { agents.push(new AgentNode(Math.random()*FIELD_LIMIT, Math.random()*FIELD_LIMIT, '#e74c3c')); }
function spawnPoint() { points.push({x:Math.random()*FIELD_LIMIT, y:Math.random()*FIELD_LIMIT, c:`hsl(${Math.random()*360},70%,60%)`, v:10}); }

function run_engine() {
    fCount++;
    if(studyMode === 'slither') {
        let tz = Math.max(0.1, 1.2 - (node.val/4500));
        viewport.zoom += (tz - viewport.zoom) * 0.05;
        viewport.x = node.x - (cv.width/2)/viewport.zoom; viewport.y = node.y - (cv.height/2)/viewport.zoom;
        ctx.fillStyle = '#fdfdfd';
    } else { viewport = {x:0, y:0, zoom:1}; ctx.fillStyle = '#aad751'; }
    
    ctx.fillRect(0, 0, cv.width, cv.height);
    ctx.save(); ctx.scale(viewport.zoom, viewport.zoom); ctx.translate(-viewport.x, -viewport.y);

    points.forEach((p, i) => {
        ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.drop?15:8, 0, 7); ctx.fill();
        [node, ...agents].forEach(s => {
            if(s.active && Math.hypot(s.x-p.x, s.y-p.y) < 40) { s.val += p.v; points.splice(i,1); if(studyMode==='classic') spawnPoint(); }
        });
    });
    if(studyMode==='slither' && points.length < 1500) spawnPoint();

    [node, ...agents].forEach(s => {
        s.process(); if(!s.active) return;
        [node, ...agents].forEach(other => {
            if(!other.active || (s===other && fCount-s.spawnF < 100)) return;
            other.pts.forEach((p, idx) => {
                if(s===other && idx < 12) return;
                if(Math.hypot(s.x-p.x, s.y-p.y) < (studyMode==='classic'?16:32)) s.reset();
            });
        });
        ctx.fillStyle = s.color;
        s.pts.forEach((p, i) => {
            ctx.beginPath(); ctx.arc(p.x, p.y, studyMode==='classic'?9:32*(1-i/s.pts.length*0.7), 0, 7); ctx.fill();
        });
    });
    ctx.restore();
    document.getElementById('data-val').innerText = Math.floor(node.val);
    if(node.active) study_loop = requestAnimationFrame(run_engine);
    else { ctx.fillStyle="#2c3e50"; ctx.font="40px sans-serif"; ctx.fillText("ANALYSIS COMPLETE", cv.width/2-200, cv.height/2); }
}
</script>
</body>
</html>
